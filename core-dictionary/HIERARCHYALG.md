Алгоритм обрабтки иерархической структуры
=========================================
Входные параметры:
    название сущности, соответствует названию с описании метамодели БД
    сущности в виде Map или List

1. Начало
2. создание линейного графа атомарных сущностей, граф представляет собой объект содержащий название сущности, действие над сущностью ('Сохранить', 'Удалить', 'Обновить', 'Не изменять'), саму сцщность в виде Map, родительскую сущность, действия над родительскими сущностями, сущность для восстановления
    2.1 нициализация графа как пустой список
    2.2 если объект сущности  Map -  обработка: 
       2.2.1 определить название сущности:
            2.2.1.1 если определена родительская сущность и поле наименования текущей сущности название сущности определяется либо  полем "$type$" в сущности или из метаданных БД по связи родительской сущности и поля ссылки на текущую сущность
            2.2.1.3 иначе это поле наименования текущей сущности
       2.2.2 записать в поле  "$type$" текущей сущности ее название
       2.2.3 определим поле первичного ключа текущей сущности из метаданных БД        
       2.2.2 создать  эемента графа: действие над сущностью , сцщность в виде Map, родительская сущность, действия над родительскими сущностями (как список действий) 
       2.2.3 проеобразуем  текущую сущность:
            2.2.3.1 приведем поля сущности к типа описания метаданных БД:
                2.2.3.1.1 получим из метаданных БД поля текущей сущности 
                2.2.3.1.2 переложим данные Map в формате название поля:тип
                2.2.3.1.3 Начало цикла - для каждого поля текущей сущности :
                    2.2.3.1.3.1 если тип значения String, Long, Integer, Float то переписываем поле типом из данных полученных в пункте 2.2.3.1.2
                2.2.3.1.4 Конец цикла    
            2.2.3.2 получим справочники из полей сущности:
                 2.2.3.2.1 получим из метаданных БД аттрибуты текущей сущности
                 2.2.3.2.2 Начало цикла - для каждого аттрибута проверим является ли он справочником 
                 2.2.3.2.3 если аттрибут это Map (с постфиксом "_EN") - сущность и в текущей сущности есть аттрибут с таким же наименование , но - "_EN", то это справочник
                 2.2.3.2.4 справочники перекладываются в Map (поле названия идентификатор, поле названия сущности)
                 2.2.3.2.5 Конец цикла
            2.2.3.3 для сущностей (полей)  справочников развернуть их содержание (найти по идентификатору):
                 2.2.3.3.1 Начало цикла - для всех справочников текущей сущности , определенных в пункте 2.2.3.1.4
                 2.2.3.3.2 Определим название сущности ссылки
                 2.2.3.3.3 получим из текущей сущности идентификатор ссылки
                 2.2.3.3.4 если значение идентификатора в текущей сущности пустое , то продолжим цикл 2.2.3.3.1
                 2.2.3.3.5 если значение ссылки  в текущей сущности не пустое , то продолжим цикл 2.2.3.3.1 (приоритет имее разврнутое значение ссылки)
                 2.2.3.3.6 по значению идентификатора ссылки (2.2.3.3.3) получим его содержание из БД
                 2.2.3.3.7 для ссылки полученной в 2.2.3.3.6 проставим действие 'Не изменять'
                 2.2.3.3.8 положим ссылку полученную в 2.2.3.3.6 в текущую сущность                 
                 2.2.3.3.9 Конец цикла                 
       2.2.4 Если граф содержит элемент созданный в  2.2.2 то завершить обработку объекта
             функция определения равенства сущностей:
             2.2.4.1 если ссылки равны то это тот же объект
             2.2.4.2 если название сущности и занчение поля идентификатор равны  то это тот же объект 
       2.2.5 добавить элемент созданный в  2.2.2 в граф  созданный в 2.1     
       2.2.6 Начало цикла - обработка всех полей текущую  Map
       2.2.7 если тип поля текущей сущности Map (M2O) то повторить 2.2
       2.2.8 если тип поля текущей сущности List (O2M):
             2.2.8.1 получить из метамодели БД название сущности
             2.2.8.2 Начало цикла - обработка списка , входные : название поля списка, название сущности входящей в список
             2.2.8.3 каждый элемент списка обработать как сущность 2.2
             2.2.8.4 для элемента списка определить ссылку на родительскую сущность (по настройке - 'записать ссылку родительской сущности'):
                2.2.8.4.1 если настройка 'записать ссылку родительской сущности' не определена и элемента списка не содержит ее  выбросить исключение
                2.2.8.4.2 получить из метамодели БД название поля ссылающиеся на родительскую сущность, название поля ищется как в элемента списка , так и в  родительских элементах метамодели данной сущности                 
                2.2.8.4.3 положить для данной сущности в поле полученное 2.2.8.4.1 родительскую сущность из объекта графа созданного в 2.2.2
             2.2.8.5 Конец цикла 
       2.2.9 Конец цикла
3. обработка графа
    3.1 подготовим граф - отсроченное обновление, проверка сущностей
        3.1.1 создать новый выходной граф
        3.1.2 Начало цикла -  для каждого элемента графа
        3.1.3 проверка элемента графа:
            3.1.3.1 проверить возможность выполенния действия, если действие не входит в список разрешенных родительских действий определенных в 2.2.2 и описанных для каждого действия то выбросить исключение
            3.1.3.2 проверить существование описания сущности в метамодели БД, если нет выбросить исключение
            3.1.3.3 проверить наличие поля идентификатора сущности при действиях над сущность 'Удалить', 'Обновить', если нет выбросить исключение
        3.1.4 конвертер графа для опрерации отсроченного обновления
            3.1.3.1 создать новый выходной граф
            3.1.3.2 если действие на элементе графа  'Обновить':
                3.1.3.2.1 создать новый элемент графа , в сущность для восстановления сохранить текущее состояние сущности элемента графаф
                3.1.3.2.2 в элемент графа , в сущность сохранить текущее состояние сущности элемента графаф с вычетом полей являющимися ссылками ( условие  тип Map , поле есть в метамодели БД)
                3.1.3.2.3 в новый выходной граф (3.1.1) добавить элемент 3.1.3.2.1 (в конец графа) 
        3.1.5 переписать граф : граф + новый выходной граф (3.1.1) 
        3.1.6 Конец цикла
    3.2 выполнить действие по графу
        3.2.1 Начало цикла -  для каждого элемента графа
        3.2.2 восстановить ссылки.  переписать сущность элемента графа из сохраненной сущности для восстановления (3.1.3.2.1)
        3.2.3 выполнить действие над сущностью на элементе графа:
            3.2.3.1 если действие 'Не изменять', при условии наличия идентификатора в сущности, начитать ее из БД
            3.2.3.2 если действие 'Сохранить' , сохранить сущность в БД (onlySave)
            3.2.3.3 если действие 'Обновить', обновить сущность в БД (merge)
            3.2.3.4 если действие 'Удалить', удалить сущность из БД (delete)
        3.2.4 Конец цикла   
4. очистка пустых параметров
    4.1 Рекурсивно обходим все элементы входной сущности и удаляем аттрибуты с нулевым значением     
5. Конец