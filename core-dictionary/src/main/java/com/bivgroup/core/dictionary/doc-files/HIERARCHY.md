Описание обрабтки иерархической структуры
=========================================

Процесс обработки разбивается на 3-а этапа

- создание линейного графа атомарных сущностей ```createGraf```
- обработка графа ```processGrafs```
- очистка пустых параметров ```cleanMap```
 
### Cоздание линейного графа
 На данном этапе происходит рекурсивный обход структуры ```processObject->(processMap,processCollection)```  и происходит выделение сущностей в отдельные объекты обработки ```EntityMap```. Данные объекты складываются последовательно в хранидище ```listGraf```.
 Выделенные объекты сущности притерпевают ряд изменений:
 
   * преобразуются к типам , соответствующим типам описания метамодели ```convertObjectToTypeModel```;
   * для объетов ,связи ManyToOne, содержащих одноименные пары полей ```...:..._EN``` (получаемых из структуры метаданных ```getDictionary```), происходит начитка связанной сущности ```replaceForJson```, т.к.это ссылка - выполняется при условии что связанное поле не ```null``` и связанная сущность найдена.
     Для начинанной при таких условиях ссылк статус изменения  - ```UNMODIFIED```, вставляется через ирархический процессор ```setProcessMap```
     Так же в данном случае наличие связанного объекта в параметрах ```.._EN```, является приоритетными и не переписывается по идентификатору связи
   * при обработке вложенным списков , определяется тип связи ```entity``` дочернего объекта ```processPcOneToMany```
   * при обработке вложенным списков , связи OneToMany, для сужностей в списке добавляется ссылка на родительский объект ```patchChildEntityByRoot```, если установлен параметр ```isInsertRootInO2M```, иначе произойдет только проверка наличия данной связи
   * при отсутствии параметра действия на сущности, выставляется действие ```INSERTED```
   * каждая сущность получает параметр описывающий ее тип ```entity - $type$```
   
 При обходе структуры повторяющиеся сущности не обрабатываются
      
### Обработка графа
  На данном этаме происходят следующие процессы:
  
   * подготовка графа ```prepareGraf```
   * восстановление ссылок в элементе графа
   * испронение CRUD действия на элементе графа 
   
#### Подготовка графа
 Процессы:
   
   * проверка ```Action.CHECK.run(this, map);```
   * отсрочка исполнения действия ```MODIFIED```
   
##### Проверяем элементы графа включает в себя следующее:
 
   * возможность выполенения данного действия , исходя их родительских действий ```chekParentAction```
   * корректность заполенения сущности ```chekCorrectMap```
   * корректность действия при наличии идентификатора сущности ```chekExistId```
 
##### Отсрочка исполнения действия ```MODIFIED```
 Для модификации сущностей , имеющих дочерние сущности , которые должны иметь поздее связывание (например создание ссылки в существующей структуре), происходит преобразование графа. Родительская сущность модифицирется дважды: на своем месте  в графе , но без ссылок; в конце графа, уже с восстановленными ссылками.
 Такая реализация не изменяет алгоритм сохранения сущностей имеющих ссылку на родительскую сужности, в тоже время позволяет сохранять выложенные ссылки родителя без изменения последовательнояти элементов графа.
  
#### Восстановление ссылок в элементе графа
 При наличии аттрибутов для восстановления ```restoresRef``` , они перемещаются в сущность элемента графа. см.Отсрочка исполнения действия ```MODIFIED``` 
    ```map.restore();```
    
#### Испронение CRUD действия на элементе графа ```RowStatus```
  Перечень CRUD действий ```processEntity```:
  
  * Не изменяем ```UNMODIFIED``` - по сути мы не  производит действий над сужностью. PS: возможно начитка сущности , если есть ее идентификатор
  * Вставка ```INSERTED``` - только сохранение сущности ```dao.onlySave```
  * Модификация ```MODIFIED``` - мерж данных, т.е. привязка сущности если она еще не привязанв ```dao.merge```
  * Удаление ```DELETED``` - удаление сущности ```dao.delete```
    
  PS. RowStatus так же определяет возможные родительские действия ```getAllowStatus```, см. Возможность выполенения данного действия 
  
### Очистка пустых параметров
 Удаляются пустые параметры из структуры через ирархический процессор ```setProcessMap``` 

 
[Подробнее описание](HIERARCHYALG.md)